# https://taskfile.dev

version: '3'

vars:
  GREETING: Hello, Welcome to SDinc ( Specialty Diagnostics Incorporated )
  SDINC_TF_VERSION: "hashicorp/terraform:1.5.2"
  SDINC_TF_DOCKER_OPTIONS: "-i -t -v ${HOME}/.aws:/root/.aws -v ${HOME}/.azure:/root/.azure -v ${HOME}/.terraform.d:/root/.terraform.d -v $(pwd):$(pwd) -w $(pwd)"
  SDINC_AZ_VERSION: "mcr.microsoft.com/azure-cli:2.51.0-arm64"
  SDINC_AZ_DOCKER_OPTIONS: "-i -t -v ${HOME}/.azure:/root/.azure -v $(pwd):$(pwd) -w $(pwd)"
  SDINC_AWS_VERSION: "public.ecr.aws/aws-cli/aws-cli:2.13.18"
  SDINC_AWS_LATEST: "public.ecr.aws/aws-cli/aws-cli:latest"
  SDINC_AWS_DOCKER_OPTIONS: "-i -t -v ${HOME}/.aws:/root/.aws -v $(pwd):$(pwd) -w $(pwd)"
  SDINC_LATEST: "sdinc:latest"
  SDINC_BAZEL_LATEST: "gcr.io/bazel-public/bazel:latest"
  SDINC_BAZEL_VERSION: "gcr.io/bazel-public/bazel:6.3.2"
  SDINC_BAZEL_DOCKER_OPTIONS: "-i -t -v ${HOME}/.aws:/root/.aws -v $(pwd):$(pwd) -w $(pwd)/bazel_files/workspace1"
  SDINC_ECR: "616843412874.dkr.ecr.us-east-1.amazonaws.com"
  EPOCH:
    sh: date +%s
tasks:
  default:
    cmds:
      - echo "{{.GREETING}}"
      - task --list
      - date -u
    silent: true
  tf-init:
    desc: "terraform init via docker backend terraform cloud"
    cmds:
      - "docker run {{.SDINC_TF_DOCKER_OPTIONS}} {{.SDINC_TF_VERSION}} init"
  tf-login:
    desc: "terraform login via docker backend terraform cloud"
    cmds:
      - "docker run {{.SDINC_TF_DOCKER_OPTIONS}} {{.SDINC_TF_VERSION}} login"
  tf-plan:
    desc: "terraform plan via docker backend terraform cloud"
    cmds:
      - "docker run {{.SDINC_TF_DOCKER_OPTIONS}} {{.SDINC_TF_VERSION}} plan"
  tf-apply:
    desc: "terraform apply via docker backend terraform cloud"
    cmds:
      - "docker run {{.SDINC_TF_DOCKER_OPTIONS}} {{.SDINC_TF_VERSION}} apply --auto-approve"
  aws-auth-ecr:
    desc: "authenticate to aws ecr repo's"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin {{.SDINC_ECR}}"
  aws-who:
    desc: "aws sts get-caller-identity"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} sts get-caller-identity"
  aws-build:
    desc: "build a aws container with bash shell"
    cmds:
      - "docker build -t {{.SDINC_LATEST}} ."
  aws-cli:
    desc: "aws sts get-caller-identity"
    cmds:
      - 'docker run --entrypoint="/bin/bash" {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_LATEST}} '
  sfefoil-down:
    desc: "pull site from s3"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} s3 sync s3://sfefoil web/sfefoil/"
  sfefoil-up:
    desc: "push site from local to s3"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} s3 sync web/sfefoil/ s3://sfefoil "
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} cloudfront create-invalidation --distribution-id E12ZXTN97X742W --paths /index.html"
  sd-down:
    desc: "pull site from s3"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} s3 sync s3://specialtydiagnostics web/specialtydiagnostics/"
  sd-up:
    desc: "push site from local to s3"
    cmds:
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} s3 sync web/specialtydiagnostics/ s3://specialtydiagnostics "
      - "docker run {{.SDINC_AWS_DOCKER_OPTIONS}} {{.SDINC_AWS_VERSION}} cloudfront create-invalidation --distribution-id E394EPQZ3ZNKW0 --paths /index.html"
  checkov:
    desc: "run checkov via docker"
    cmds:
      - "docker run {{.SDINC_TF_DOCKER_OPTIONS}}  bridgecrew/checkov --directory $(pwd) "
  az-cli:
    cmds:
      - "docker run {{.SDINC_AZ_DOCKER_OPTIONS}} {{.SDINC_AZ_VERSION}} "
  mac-bb:
    desc: "MBP bazel build from container"
    cmds:
      - 'docker run -e USER="$(id -u)" -u="$(id -u)" {{.SDINC_BAZEL_DOCKER_OPTIONS}} {{.SDINC_BAZEL_VERSION}} --output_user_root=$(pwd)/bazel_files/workspace1/build_output build '
  bazel-build:
    desc: "run bazel build from container"
    cmds:
      - "SDINC_BAZEL_LATEST"